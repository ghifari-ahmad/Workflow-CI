name: CI Pipeline for ML Project

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-train:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout kode
    - uses: actions/checkout@v3

    # 2. Setup Python
    - name: Set up Python 3.12.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.10' 

    # 3. Install Dependencies
    - name: Install dependencies
      run: |
        pip install mlflow scikit-learn pandas numpy

    # 4. Run Training Script
    - name: Train Model
      run: |
        cd MLProject
        python modelling.py

    # 5. DEBUG: Cek struktur folder (Opsional, untuk memastikan mlruns ada)
    - name: Debug Directory Structure
      run: |
        echo "Listing MLProject directory:"
        ls -R MLProject

    # 6. Build Docker Image (PERBAIKAN DI SINI)
    - name: Build Docker Image using MLflow
      run: |
        # Kita cari folder run terakhir tanpa peduli ID eksperimennya (0, 1, dst)
        # ls -td mengurutkan berdasarkan waktu (terbaru di atas)
        # MLProject/mlruns/*/* artinya: cari di semua ID eksperimen, dan semua Run ID
        
        LATEST_RUN=$(ls -td MLProject/mlruns/*/* | head -1)
        
        echo "Latest Run Path detected: $LATEST_RUN"
        
        if [ -z "$LATEST_RUN" ]; then
          echo "Error: Tidak ada MLflow run yang ditemukan!"
          exit 1
        fi

        # Pastikan folder model ada di dalamnya (biasanya di artifacts/model)
        MODEL_PATH="$LATEST_RUN/artifacts/model"
        echo "Model Path: $MODEL_PATH"

        # Build image. Ganti 'ghifariahmad20' sesuai username Docker Hub kamu
        # Pastikan nama image SAMA persis dengan langkah Push nanti
        mlflow models build-docker -m "$MODEL_PATH" -n "ghifariahmad20/submission-model:latest" --enable-mlserver

    # 7. Login & Push ke Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Push to Docker Hub
      run: |
        # Perhatikan: Nama image harus SAMA dengan yang di-build di langkah sebelumnya
        docker push ghifariahmad20/submission-model:latest
