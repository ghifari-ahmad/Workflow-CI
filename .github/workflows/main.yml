name: CI Pipeline for ML Project

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-train:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout kode
    - uses: actions/checkout@v3

    # 2. Setup Python
    - name: Set up Python 3.12.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.10' 

    # 3. Install Dependencies
    - name: Install dependencies
      run: |
        pip install mlflow scikit-learn pandas numpy

    # 4. Run Training Script
    - name: Train Model
      run: |
        cd MLProject
        python modelling.py

    # 5. DEBUG: Cek struktur folder (Opsional, untuk memastikan mlruns ada)
    - name: Debug Directory Structure
      run: |
        echo "Listing MLProject directory:"
        ls -R MLProject

    # 6. Build Docker Image (PERBAIKAN DI SINI)
    - name: Build Docker Image using MLflow
      run: |
        echo "Mencari lokasi model..."
        
        # LOGIKA BARU:
        # Gunakan 'find' untuk mencari folder bernama "model" yang ada di dalam "artifacts"
        # Pipe ke 'ls -td' untuk mengurutkan berdasarkan waktu (terbaru paling atas)
        # Ambil baris pertama
        
        MODEL_DIR=$(find MLProject/mlruns -type d -path "*/artifacts/model" | xargs ls -td | head -n 1)
        
        if [ -z "$MODEL_DIR" ]; then
          echo "Error: Model directory tidak ditemukan! Pastikan modelling.py berhasil dijalankan."
          # Debugging: Tampilkan isi folder mlruns untuk pengecekan
          ls -R MLProject/mlruns
          exit 1
        fi

        echo "Path model ditemukan: $MODEL_DIR"

        # Build image menggunakan path yang sudah pasti benar
        mlflow models build-docker -m "$MODEL_DIR" -n "ghifariahmad20/submission-model:latest" --enable-mlserver

    # 7. Login & Push ke Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Push to Docker Hub
      run: |
        # Perhatikan: Nama image harus SAMA dengan yang di-build di langkah sebelumnya
        docker push ghifariahmad20/submission-model:latest
