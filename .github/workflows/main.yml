name: CI Pipeline for ML Project

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-train:
    runs-on: ubuntu-latest
    
    steps:
    # Checkout kode
    - uses: actions/checkout@v3

    # Setup Python
    - name: Set up Python 3.12.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.10' 

    # Install Dependencies
    - name: Install dependencies
      run: |
        pip install -r MLProject/requirements.txt

    # Run Training Script
    - name: Train Model
      run: |
        cd MLProject
        python modelling.py

    # Build Docker Image
    - name: Build Docker Image using MLflow
      run: |
        
        # Path Absolut Project
        PROJECT_DIR=$(pwd)/MLProject
        
        # Cari folder berisi MLmodel (Absolute Path)
        MODEL_DIR=$(find "$PROJECT_DIR/mlruns" -name "MLmodel" | xargs dirname | head -n 1)
        
        if [ -z "$MODEL_DIR" ]; then
          ls -R MLProject/mlruns
          exit 1
        fi

        echo "âœ… Path model ditemukan: $MODEL_DIR"
        
        # Build image pakai Absolute Path
        mlflow models build-docker -m "$MODEL_DIR" -n "ghifariahmad20/submission-model:latest" --enable-mlserver

    # Login & Push ke Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Push to Docker Hub
      run: |
        docker push ghifariahmad20/submission-model:latest
