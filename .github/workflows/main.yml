name: CI Pipeline for ML Project

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-train:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout kode dari repo
    - uses: actions/checkout@v3

    # 2. Setup Python
    - name: Set up Python 3.12.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.10'

    # 3. Install Dependencies
    - name: Install dependencies
      run: |
        pip install mlflow scikit-learn pandas numpy
        # Install Docker jika diperlukan environment khusus, 
        # tapi ubuntu-latest sudah punya docker client.

    # 4. Run Training Script
    - name: Train Model
      run: |
        cd MLProject
        python modelling.py

    # 5. Build Docker Image (Kriteria Advance)
    # Perintah ini akan mencoba membungkus model hasil training terakhir menjadi image
    - name: Build Docker Image using MLflow
      run: |
        # Kita ambil run_id terakhir dari folder mlruns (lokal)
        # Catatan: Dalam production nyata, kita pakai Tracking Server, 
        # tapi untuk tugas submission ini, kita pakai local path.
        
        LATEST_RUN=$(ls -td MLProject/mlruns/0/* | head -1)
        RUN_ID=$(basename $LATEST_RUN)
        
        echo "Building Docker image for Run ID: $RUN_ID"
        
        # Build image dengan nama 'my-model-image'
        mlflow models build-docker -m "$LATEST_RUN/artifacts/model" -n "ghifariahmad20/submission-model:latest" --enable-mlserver

    # 6. Login & Push ke Docker Hub (Opsional tapi disarankan untuk Advance)
    # Kamu perlu set DOCKER_USERNAME dan DOCKER_PASSWORD di GitHub Secrets
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Push to Docker Hub
      run: |
        docker push my_docker_username/submission-model:latest
